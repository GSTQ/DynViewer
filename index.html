<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Просмотрищик динамограмм</title>
  </head>
  <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
  <body>
    <script>
      // You can also require other files to run in this process
      require('./renderer.js')
    </script>
    <script src="db.js"></script>
  <script>
    window.$ = window.jQuery = require('jquery');
    const Highcharts = require('highcharts')
    require('highcharts/modules/data')(Highcharts)
  </script>
  <div class="container-fluid full-height">
      <div class="row content full-height">
          <div class="col-sm-3 full-height">
              <h4>Список скважин:</h4>
              <ul class="list-group scrollable" id = "wells">
              </ul>
          </div>
          <div class="col-sm-3 full-height">
              <h4>Динамограммы:</h4>
              <ul class="list-group scrollable" id = "dynamograms">
              </ul>
          </div>
          <div class="col-sm-6 scrollable">
            <div id = "chart-container">
            </div>
            <div class="row classifier-tables">
              <div class="col-sm-6">
                <h6>Результаты распознования классификатора 1</h6>
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>Класс</th>
                      <th>Уверенность</th>
                    </tr>
                  </thead>
                  <tbody id="classifier1"></tbody>
                </table>
              </div>
              <div class="col-sm-6">
                <h6>Результаты распознования классификатора 2</h6>
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>Класс</th>
                      <th>Уверенность</th>
                    </tr>
                  </thead>
                  <tbody id="classifier2"></tbody>
                </table>
              </div>
            </div>
          </div>
      </div>
  </div>
  <script>
      $( document ).ready(function() {
        db.each("SELECT well_id as well_name, count(dyn_id) as count FROM dynamograms group by well_id", function(err, row) {
           $('#wells').append('<li class="list-group-item well-item" id="' + row.well_name +'">' + "Скв." + row.well_name + ' <span class="badge badge-default badge-pill">' + row.count + '</span></li>');
        });
        $(document).on ("click", ".well-item", function () {
          $('.dyn-item').remove();
          $(".well-item").removeClass("active");
          $(this).addClass("active");
          var id = $(this).attr('id');
          db.each("SELECT dyn_id, dt FROM dynamograms WHERE well_id = " + id, function(err, row) {
            $('#dynamograms').append('<li class="list-group-item dyn-item" id="' + row.dyn_id +'">' + row.dt + '</li>');
          });
        });
        $(document).on ("click", ".dyn-item", function () {
          $(".dyn-item").removeClass("active");
          $(this).addClass("active");
          var id = $(this).attr('id');
          db.each("SELECT dyn_id, dt, position_data, load_data FROM dynamograms WHERE dyn_id = " + id, function(err, row) {
          var position = row.position_data.split(';').map(function(item) {
            return parseFloat(item);
          });
          var load = row.load_data.split(';').map(function(item) {
            return parseFloat(item);
          });
          var series_data = position.map(function(e, i) {
            return [e, load[i]];
          });
          Highcharts.chart('chart-container', {
            chart: {
              type: 'spline'
            },
            title: {
              text: 'Динамограмма на ' + row.dt
            },
            xAxis: {
              reversed: false,
              title: {
                enabled: true,
                text: 'Ход штока, мм'
              },
              maxPadding: 0.05,
              showLastLabel: true,
              lineWidth: 2,
              gridLineWidth: 1
            },
            yAxis: {
              title: {
                text: 'Нагрузка, кгс'
              },
              lineWidth: 2
            },
            legend: {
              enabled: false
            },
            tooltip: {
              headerFormat: '<b>{series.name}</b><br/>',
              pointFormat: 'Позиция штока: {point.x} мм Нагрузка {point.y} кгс'
            },
            plotOptions: {
              spline: {
                marker: {
                  enable: false
                }
              }
            },
            series: [{
              name: 'Динамограмма',
              data: series_data
            }]
          });
          $(".classifier-tables").css("visibility","visible");
          $('.classifier-result').remove();

          var classifier1_values = new Map();
          var classifier1_max = -1.0;
          db.each("select dyn_classes.class_id, value, class_name from dyn_classes left join dyn_class_dict on dyn_class_dict.class_id = dyn_classes.class_id  where dyn_classes.dyn_id = " + id + ' and classifier_id = 1', function(err, row) {
            classifier1_values.set(row.class_name, row.value);
            if(row.value > classifier1_max){
              classifier1_max = row.value;
            }
          },
          function(){
            classifier1_values.forEach(function (item, key, mapObj) {
              if(item == classifier1_max)
              {
                $('#classifier1').append('<tr class = "classifier-result good-value"><td>' + key + '</td><td>' + item +'</td></tr>');
              }
              else
              {
                $('#classifier1').append('<tr class = "classifier-result"><td>' + key + '</td><td>' + item +'</td></tr>');
              }
            });
          });
          var classifier2_values = new Map();
          var classifier2_max = -1.0;
          db.each("select dyn_classes.class_id, value, class_name from dyn_classes left join dyn_class_dict on dyn_class_dict.class_id = dyn_classes.class_id  where dyn_classes.dyn_id = " + id + ' and classifier_id = 2', function(err, row) {
            classifier2_values.set(row.class_name, row.value);
            if(row.value > classifier2_max){
              classifier2_max = row.value;
            }
          },
          function(){
            classifier2_values.forEach(function (item, key, mapObj) {
              if(item == classifier2_max)
              {
                $('#classifier2').append('<tr class = "classifier-result good-value"><td>' + key + '</td><td>' + item +'</td></tr>');
              }
              else
              {
                $('#classifier2').append('<tr class = "classifier-result"><td>' + key + '</td><td>' + item +'</td></tr>');
              }
            });
          });
        });
        
      });  
    });  
  </script>
  </body>
</html>
